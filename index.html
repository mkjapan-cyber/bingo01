<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OCR対応ビンゴチェッカー</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    table { border-collapse: collapse; margin-bottom: 1em; }
    td { border: 1px solid #ccc; width: 50px; height: 50px; text-align: center; }
    input[type="number"] { width: 45px; text-align: center; }
    #result { font-size: 1.2em; font-weight: bold; color: green; }
    .free { background: #eee; }
  </style>
</head>
<body>

<h1>OCR対応ビンゴチェッカー</h1>

<h3>1. カード画像をアップロード（数字が5行に並ぶように撮影）</h3>
<input type="file" accept="image/*" capture="environment" onchange="runOCR(this)" />
<p id="ocrStatus">読み込み待機中</p>

<h3>2. ビンゴカードの自動入力（中央はFREEマス）</h3>
<table id="bingoTable"><tbody></tbody></table>

<h3>3. 当選番号をカンマ区切りで入力</h3>
<input type="text" id="drawnNumbers" placeholder="例: 5,12,30,44,..."/>
<button onclick="checkBingo()">判定</button>
<p id="result">判定結果：未実行</p>

<script>
  const tableBody = document.querySelector("#bingoTable tbody");

  // ビンゴマスの入力欄を作成
  for (let row = 0; row < 5; row++) {
    const tr = document.createElement("tr");
    for (let col = 0; col < 5; col++) {
      const td = document.createElement("td");
      const input = document.createElement("input");
      input.type = "number";
      input.min = 1;
      input.max = 75;
      input.id = `cell-${row}-${col}`;
      if (row === 2 && col === 2) {
        input.value = "FREE";
        input.disabled = true;
        td.classList.add("free");
      }
      td.appendChild(input);
      tr.appendChild(td);
    }
    tableBody.appendChild(tr);
  }

  function checkBingo() {
    const drawnText = document.getElementById("drawnNumbers").value;
    const drawnSet = new Set(
      drawnText.split(",").map(x => x.trim()).filter(x => x !== "").map(x => parseInt(x, 10))
    );
    const card = [];

    for (let r = 0; r < 5; r++) {
      const row = [];
      for (let c = 0; c < 5; c++) {
        const cell = document.getElementById(`cell-${r}-${c}`);
        row.push(r === 2 && c === 2 ? "FREE" : parseInt(cell.value, 10));
      }
      card.push(row);
    }

    let bingoCount = 0;

    // 横
    for (let r = 0; r < 5; r++) {
      if (card[r].every(n => n === "FREE" || drawnSet.has(n))) bingoCount++;
    }

    // 縦
    for (let c = 0; c < 5; c++) {
      if ([0,1,2,3,4].every(r => card[r][c] === "FREE" || drawnSet.has(card[r][c]))) bingoCount++;
    }

    // 斜め
    if ([0,1,2,3,4].every(i => card[i][i] === "FREE" || drawnSet.has(card[i][i]))) bingoCount++;
    if ([0,1,2,3,4].every(i => card[i][4-i] === "FREE" || drawnSet.has(card[i][4-i]))) bingoCount++;

    document.getElementById("result").textContent = `判定結果：ビンゴ ${bingoCount} ライン`;
  }

  function runOCR(input) {
    const file = input.files[0];
    if (!file) return;

    const status = document.getElementById("ocrStatus");
    status.textContent = "OCR解析中...";

    const reader = new FileReader();
    reader.onload = function () {
      const img = new Image();
      img.onload = () => {
        const MAX_WIDTH = 640;
        const scale = MAX_WIDTH / img.width;
        const canvas = document.createElement("canvas");
        canvas.width = MAX_WIDTH;
        canvas.height = img.height * scale;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        Tesseract.recognize(canvas, 'eng', {
          logger: m => console.log(m)
        }).then(({ data: { text } }) => {
          if (!text || text.trim() === "") {
            status.textContent = "認識できる文字が見つかりませんでした。";
            return;
          }

          status.textContent = "OCR完了。自動入力中...";
          const lines = text.trim().split('\n').filter(line => line.trim() !== '');

          for (let r = 0; r < 5; r++) {
            const nums = lines[r]?.match(/\d+/g);
            if (!nums || nums.length < 5) continue;
            for (let c = 0; c < 5; c++) {
              const id = `cell-${r}-${c}`;
              if (!(r === 2 && c === 2)) {
                const val = parseInt(nums[c], 10);
                document.getElementById(id).value = isNaN(val) ? "" : val;
              }
            }
          }
        }).catch(err => {
          status.textContent = "OCRエラー：" + err.message;
        });
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  }
</script>
</body>
</html>
